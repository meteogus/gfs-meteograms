name: Run and Upload Meteograms via SFTP

on:
  schedule:
    - cron: "0 3,6 * * *"  # At 03:00 and 06:00 UTC daily
  workflow_dispatch:       # Allow manual trigger in GitHub

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install paramiko

      - name: Run meteogram scripts
        run: |
          python athens.py
          python kiato.py
          python lamia.py
          python london.py

      - name: Upload images via SFTP with paramiko
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          SFTP_FOLDER: ${{ secrets.SFTP_FOLDER }}
        run: |
          python - <<EOF
import paramiko
import os

host = os.environ['SFTP_HOST']
port = int(os.environ.get('SFTP_PORT', 22))
user = os.environ['SFTP_USER']
password = os.environ['SFTP_PASS']
folder = os.environ.get('SFTP_FOLDER', '/').rstrip('/')

files = [
    'athens_meteogram.png',
    'kiato_meteogram.png',
    'lamia_meteogram.png',
    'london_meteogram.png'
]

print('ðŸŒ Connecting to SFTP server...')
transport = paramiko.Transport((host, port))
transport.connect(username=user, password=password)
sftp = paramiko.SFTPClient.from_transport(transport)

for f in files:
    local_path = f
    remote_path = folder + '/' + f
    print(f'Uploading {local_path} to {remote_path} ...')
    sftp.put(local_path, remote_path)

sftp.close()
transport.close()
print('âœ… All files uploaded successfully.')
EOF
