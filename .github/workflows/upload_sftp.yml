name: Trigger GitHub Meteogram Workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  repository_dispatch:
    types: [run-meteograms]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout repository
        uses: actions/checkout@v4

      - name: ‚úÖ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ‚úÖ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install paramiko

      - name: ‚úÖ Determine latest GFS run hour
        id: gfs_run
        run: |
          hour=$(date -u +"%H")
          if ((hour >= 0 && hour < 6)); then
              run_hour="00"
          elif ((hour >= 6 && hour < 12)); then
              run_hour="06"
          elif ((hour >= 12 && hour < 18)); then
              run_hour="12"
          else
              run_hour="18"
          fi
          echo "üïí Current UTC hour: $hour"
          echo "üì¶ Using GFS run hour: $run_hour"
          echo "run_hour=$run_hour" >> $GITHUB_ENV

      - name: ‚úÖ Run meteogram scripts
        run: |
          set +e  # üëà continue even if a script fails
          python athens.py || echo "‚ö†Ô∏è athens.py failed"
          python kiato.py || echo "‚ö†Ô∏è kiato.py failed"
          python lamia.py || echo "‚ö†Ô∏è lamia.py failed"
          python london.py || echo "‚ö†Ô∏è london.py failed"
        env:
          RUN_HOUR: ${{ env.run_hour }}

      - name: ‚úÖ Upload images via SFTP with paramiko (with timeout)
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          SFTP_FOLDER: ${{ secrets.SFTP_FOLDER }}
          RUN_HOUR: ${{ env.run_hour }}
        timeout-minutes: 2 # ‚è≥ hard stop if this step runs >2 min
        run: |
          if [ -z "$SFTP_HOST" ] || [ -z "$SFTP_USER" ] || [ -z "$SFTP_PASS" ]; then
              echo "‚ö†Ô∏è SFTP credentials not set. Skipping upload step."
              exit 0
          fi

          python - <<'EOF'
          import paramiko
          import os
          import sys
          import socket

          run_hour = os.getenv('RUN_HOUR', '00')
          print(f"üïí Using run_hour: {run_hour}")

          files = [
              f"athens{run_hour}.png",
              f"kiato{run_hour}.png",
              f"lamia{run_hour}.png",
              "london.png"  # static filename
          ]

          host = os.getenv('SFTP_HOST')
          port = int(os.getenv('SFTP_PORT', '22'))
          user = os.getenv('SFTP_USER')
          password = os.getenv('SFTP_PASS')
          folder = os.getenv('SFTP_FOLDER', '/').rstrip('/')

          print(f"üì° Connecting to {host}:{port} as {user} ...")

          try:
              # ‚è≥ set 10-second socket timeout
              socket.setdefaulttimeout(10)
              transport = paramiko.Transport((host, port))
              transport.connect(username=user, password=password)
              sftp = paramiko.SFTPClient.from_transport(transport)
          except Exception as e:
              print(f"‚ùå Failed to connect or authenticate: {e}")
              sys.exit(1)

          for f in files:
              try:
                  local_path = f
                  remote_path = f"{folder}/{f}"
                  print(f"‚¨ÜÔ∏è Uploading {local_path} to {remote_path} ...")
                  sftp.put(local_path, remote_path)
              except Exception as e:
                  print(f"‚ùå Failed to upload {f}: {e}")

          sftp.close()
          transport.close()
          print("‚úÖ All files uploaded successfully.")
          EOF
